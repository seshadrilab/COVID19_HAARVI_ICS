---
title: "Post-COMPASS Plots"
author: "Malisa Smith"
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
date: "version `r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
---

Consider the cohort as a single group to start.  Do not stratify by case-control status.

Stack the heatmaps for CD4.  Are there obvious patterns to the antigens?  
Stack the heatmaps for NOTCD4.  Are there patterns?  Are these patterns different from CD4?

Calculate FS/PFS for each stimulation in CD4 and compare side-by-side in boxplots and test by ANOVA.  Is there a clear winner?
Calculate FS/PFS for each stimulation in NOTCD4 and compare with boxplot and ANOVA.  Is there a winner?  Is this different than CD4?

It may also make sense to make a corrplot of the FS/PFS from the different stims. This is asking a different question though, i.e. whether a patient's cytokine responses tend to be consistently elevated/not-elevated across multiple stims.

Regress FS/PFS against age (linear).  Is there an effect of age on T cell functionality?
Regress FS/PFS against days from symptom onset (linear).  Is there a decrease in functionality with time?
Stratify FS/PFS by sex and test by t-test (or Mann-Whitney, though sample size is large enough).  Is there a difference?
   
Only then would you start asking the case-control questions.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=F}
library(here)
library(tidyverse)
library(COMPASS)
library(ggplot2)
library(data.table)
library(broom)
library(psych)
library(corrplot)
library(ggpubr)
library(knitr)
library(kableExtra)
library(cowplot)
source(here::here("scripts/my_pheatmap_and_plotMeanGamma.R"))
source(here::here("scripts/20200604_Helper_Functions.R"))
```

```{r}
save_output <- FALSE
```

# Read in data

```{r read in data}
# Next 4 lines from Run_COMPASS.R
stims_for_compass_runs <- c("VEMP", "Spike 1", "Spike 2", "NCAP")
parent_nodes_for_compass_runs <- c("4+", "NOT4+", "8+")
stims_for_compass_runs_rep <- rep(stims_for_compass_runs, each = length(parent_nodes_for_compass_runs))
parent_nodes_for_compass_runs_rep <- rep(parent_nodes_for_compass_runs, times = length(stims_for_compass_runs))

crList <- purrr::pmap(.l = list(parent_nodes_for_compass_runs_rep,
                                stims_for_compass_runs_rep),
                      .f = function(parent, currentStim) {
                        currentStimForFile <- gsub(" ", "_", currentStim)
                        crPath <- here::here(sprintf("out/CompassOutput/%s/%s/COMPASSResult_%s_%s.rds", parent, currentStimForFile, parent, currentStimForFile))
                        readRDS(crPath)
                      }) %>% 
  set_names(gsub("+", "", gsub(" ", "_", paste0(parent_nodes_for_compass_runs_rep, "_", stims_for_compass_runs_rep)), fixed=TRUE))
names(crList)

CD4RunNames <- c("4_Spike_1", "4_Spike_2", "4_NCAP", "4_VEMP")
NotCD4RunNames <- c("NOT4_Spike_1", "NOT4_Spike_2", "NOT4_NCAP", "NOT4_VEMP")
CD8RunNames <- c("8_Spike_1", "8_Spike_2", "8_NCAP", "8_VEMP")
```

# Stacked heatmaps
```{r, fig.width=12, fig.height=10}
plotCOMPASSResultStack(crList[CD4RunNames],
                       row_annotation = c("Stim"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13)
```

```{r, fig.width=12, fig.height=10}
plotCOMPASSResultStack(crList[NotCD4RunNames],
                       row_annotation = c("Stim"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "Not-CD4 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13)
```

```{r, fig.width=12, fig.height=10}
plotCOMPASSResultStack(crList[CD8RunNames],
                       row_annotation = c("Stim"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD8 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13)
```

```{r, fig.width=12, fig.height=15}
plotCOMPASSResultStack(crList[c(CD4RunNames, NotCD4RunNames)],
                       row_annotation = c("Stim"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4 and Not-CD4 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13)
```

```{r, fig.width=12, fig.height=15}
plotCOMPASSResultStack(crList[c(CD4RunNames, CD8RunNames)],
                       row_annotation = c("Stim"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4 and CD8 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13)
```

```{r, fig.width=12, fig.height=20}
plotCOMPASSResultStack(crList[c(CD4RunNames, NotCD4RunNames, CD8RunNames)],
                       row_annotation = c("Stim"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4, Not-CD4, and CD8 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13)
```

```{r save stacked heatmaps}
if(save_output) {
  png(filename=here::here("out/PostCompassPlots/20200805_CD4_COMPASS_Heatmap_All_Stims.png"),
      width=700, height=1000)
  plotCOMPASSResultStack(crList[CD4RunNames],
                         row_annotation = c("Stim"),
                         variable = "Stim",
                         show_rownames = FALSE,
                         main = "CD4 COMPASS Runs",
                         fontsize = 14, fontsize_row = 13, fontsize_col = 13)
  dev.off()
  
  png(filename=here::here("out/PostCompassPlots/20200805_NotCD4_COMPASS_Heatmap_All_Stims.png"),
      width=700, height=1000)
  plotCOMPASSResultStack(crList[NotCD4RunNames],
                         row_annotation = c("Stim"),
                         variable = "Stim",
                         show_rownames = FALSE,
                         main = "Not-CD4 COMPASS Runs",
                         fontsize = 14, fontsize_row = 13, fontsize_col = 13)
  dev.off()
  
  png(filename=here::here("out/PostCompassPlots/20200805_CD8_COMPASS_Heatmap_All_Stims.png"),
    width=700, height=1000)
  plotCOMPASSResultStack(crList[CD8RunNames],
                         row_annotation = c("Stim"),
                         variable = "Stim",
                         show_rownames = FALSE,
                         main = "CD8 COMPASS Runs",
                         fontsize = 14, fontsize_row = 13, fontsize_col = 13)
  dev.off()
  
  png(filename=here::here("out/PostCompassPlots/20200805_CD4_and_NotCD4_COMPASS_Heatmap_All_Stims.png"),
      width=900, height=2000)
  plotCOMPASSResultStack(crList[c(CD4RunNames, NotCD4RunNames)],
                         row_annotation = c("Stim"),
                         variable = "Stim",
                         show_rownames = FALSE,
                         main = "CD4 and Not-CD4 COMPASS Runs",
                         fontsize = 14, fontsize_row = 13, fontsize_col = 13)
  dev.off()
}
```

# FS/PFS across Stims

```{r, fig.width = 13, fig.height=5}
fs_pfs_df <- lapply(c(CD4RunNames, NotCD4RunNames, CD8RunNames), function(n) {
  as.data.frame(COMPASS::FunctionalityScore(crList[[n]])) %>%
    rownames_to_column("SAMPLE ID") %>% 
    rename(FS = `COMPASS::FunctionalityScore(crList[[n]])`) %>% 
    left_join(as.data.frame(COMPASS::PolyfunctionalityScore(crList[[n]])) %>%
      rownames_to_column("SAMPLE ID") %>% 
      rename(PFS = `COMPASS::PolyfunctionalityScore(crList[[n]])`),
      by = "SAMPLE ID") %>% 
    mutate(COMPASS_run = n)
  } ) %>% 
  data.table::rbindlist() %>% 
  separate(COMPASS_run, into = c("parent", "STIM"), remove = F, extra = "merge") %>% 
  mutate(STIM = factor(STIM, levels = c("Spike_1", "Spike_2", "NCAP", "VEMP")))#,
         #`SAMPLE ID` = factor(`SAMPLE ID`, levels = unique(`SAMPLE ID`)))

table(fs_pfs_df$STIM, fs_pfs_df$`SAMPLE ID`) # remove 551432/07B for quade.test in order to have complete block design
fs_pfs_df.complete <- fs_pfs_df %>%
             dplyr::filter(`SAMPLE ID` != "551432") %>% 
  arrange(STIM, `SAMPLE ID`)
fs_pfs_df.complete.4 <- fs_pfs_df.complete %>% dplyr::filter(parent == "4") %>% 
             mutate(`SAMPLE ID` = factor(`SAMPLE ID`, levels = unique(`SAMPLE ID`)))
fs_pfs_df.complete.not4 <- fs_pfs_df.complete %>% dplyr::filter(parent == "NOT4") %>% 
             mutate(`SAMPLE ID` = factor(`SAMPLE ID`, levels = unique(`SAMPLE ID`)))
# And for CD8 need to remove more individuals for complete block design
fs_pfs_df.complete.8 <- fs_pfs_df.complete %>% dplyr::filter(parent == "8") %>% 
  dplyr::filter(!(`SAMPLE ID` %in% c("BWT20", "15548", "15530"))) %>% 
             mutate(`SAMPLE ID` = factor(`SAMPLE ID`, levels = unique(`SAMPLE ID`)))

# Perform statistical tests for Functionality Score across Stims
# Quade test is to wilcoxon signed rank test like ANOVA is to t-test
quade_fs_4 <- quade.test(FS ~ STIM | `SAMPLE ID`, data = fs_pfs_df.complete.4)
quade_fs_4
quade_fs_not4 <- quade.test(FS ~ STIM | `SAMPLE ID`, data = fs_pfs_df.complete.not4)
quade_fs_not4
quade_fs_8 <- quade.test(FS ~ STIM | `SAMPLE ID`, data = fs_pfs_df.complete.8)
quade_fs_8

pw_fs_4 <- pairwise.wilcox.test(fs_pfs_df.complete.4$FS,
                      fs_pfs_df.complete.4$STIM,
                      p.adjust.method="bonferroni",
                      paired=TRUE)
pw_fs_4$p.value
broom::tidy(pw_fs_4)

pw_fs_not4 <- pairwise.wilcox.test(fs_pfs_df.complete.not4$FS,
                      fs_pfs_df.complete.not4$STIM,
                      p.adjust.method="bonferroni",
                      paired=TRUE)
pw_fs_not4$p.value
broom::tidy(pw_fs_not4)

pw_fs_8 <- pairwise.wilcox.test(fs_pfs_df.complete.8$FS,
                      fs_pfs_df.complete.8$STIM,
                      p.adjust.method="bonferroni",
                      paired=TRUE)
pw_fs_8$p.value
broom::tidy(pw_fs_8)

# Perform statistical tests for PolyFunctionality Score across Stims
quade_pfs_4 <- quade.test(PFS ~ STIM | `SAMPLE ID`, data = fs_pfs_df.complete.4)
quade_pfs_4
quade_pfs_not4 <- quade.test(PFS ~ STIM | `SAMPLE ID`, data = fs_pfs_df.complete.not4)
quade_pfs_not4
quade_pfs_8 <- quade.test(PFS ~ STIM | `SAMPLE ID`, data = fs_pfs_df.complete.8)
quade_pfs_8

pw_pfs_4 <- pairwise.wilcox.test(fs_pfs_df.complete.4$PFS,
                      fs_pfs_df.complete.4$STIM,
                      p.adjust.method="bonferroni",
                      paired=TRUE)
pw_pfs_4$p.value
# broom::tidy(pw_pfs_4)

pw_pfs_not4 <- pairwise.wilcox.test(fs_pfs_df.complete.not4$PFS,
                      fs_pfs_df.complete.not4$STIM,
                      p.adjust.method="bonferroni",
                      paired=TRUE)
pw_pfs_not4$p.value
# broom::tidy(pw_pfs_not4)

pw_pfs_8 <- pairwise.wilcox.test(fs_pfs_df.complete.8$PFS,
                      fs_pfs_df.complete.8$STIM,
                      p.adjust.method="bonferroni",
                      paired=TRUE)
pw_pfs_8$p.value
# broom::tidy(pw_pfs_8)

# Now plot the results
# Note that the dataset used in statistics excludes 551432, but 551432 is plotted below (and the median bar is calculated including 551432)
# Same goes for "BWT20", "15548", "15530" in CD8 tests

parent.labs <- c("CD4", "Not-CD4", "CD8")
names(parent.labs) <- c("4", "NOT4", "8")

plot_fs_pfs_vs_stim <- function(fs_or_pfs) {
  ggplot(fs_pfs_df,
         aes(STIM, !!as.name(fs_or_pfs))) +
    theme_bw(base_size = 22) +
    geom_line(aes(group = `SAMPLE ID`), color="grey") +
    geom_point(color="grey") +
    facet_grid(. ~ parent,
               labeller = labeller(parent = parent.labs)) +
    geom_errorbarh(data = fs_pfs_df %>% group_by(parent, STIM) %>% summarise(med = median(!!as.name(fs_or_pfs))),
                   aes(y = med,
                       xmax = 1.5 + 0.35,
                       xmin = 1.5 - 0.35,
                       height = 0),
                   position=position_dodge(width=0), color = "black") +
    labs(title = sprintf("%s vs Stim", fs_or_pfs),
         y = fs_or_pfs) +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(size=22),
          axis.text.y = element_text(color="black", size=22),
          axis.text.x = element_text(color="black", size=22),
          plot.title = element_text(hjust = 0.5),
          panel.grid = element_blank(),
          legend.position = "none",
          plot.margin = margin(1.3, 0.2, 0, 0.2, "cm")) +
    scale_x_discrete(labels=c(c("Spike_1" = "Spike 1", "Spike_2" = "Spike 2")),
                     expand = c(0.1,0.1))
}

plot_fs_pfs_vs_stim("FS")
# Remembering these p-values are adjusted
as.data.frame(pw_fs_4$p.value) %>% 
  rownames_to_column('tmp') %>% 
  mutate_all(~cell_spec(.x, color = ifelse(!is.na(.x) & .x < 0.05, "red", "black"))) %>%
  column_to_rownames('tmp') %>% 
  kable(format = "html", escape = F, row.names = T) %>%
  kable_styling("striped", full_width = F)

as.data.frame(pw_fs_not4$p.value) %>% 
  rownames_to_column('tmp') %>% 
  mutate_all(~cell_spec(.x, color = ifelse(!is.na(.x) & .x < 0.05, "red", "black"))) %>%
  column_to_rownames('tmp') %>% 
  kable(format = "html", escape = F, row.names = T) %>%
  kable_styling("striped", full_width = F)

as.data.frame(pw_fs_8$p.value) %>% 
  rownames_to_column('tmp') %>% 
  mutate_all(~cell_spec(.x, color = ifelse(!is.na(.x) & .x < 0.05, "red", "black"))) %>%
  column_to_rownames('tmp') %>% 
  kable(format = "html", escape = F, row.names = T) %>%
  kable_styling("striped", full_width = F)

plot_fs_pfs_vs_stim("PFS")
as.data.frame(pw_pfs_4$p.value) %>% 
  rownames_to_column('tmp') %>% 
  mutate_all(~cell_spec(.x, color = ifelse(!is.na(.x) & .x < 0.05, "red", "black"))) %>%
  column_to_rownames('tmp') %>% 
  kable(format = "html", escape = F, row.names = T) %>%
  kable_styling("striped", full_width = F)

as.data.frame(pw_pfs_not4$p.value) %>% 
  rownames_to_column('tmp') %>% 
  mutate_all(~cell_spec(.x, color = ifelse(!is.na(.x) & .x < 0.05, "red", "black"))) %>%
  column_to_rownames('tmp') %>% 
  kable(format = "html", escape = F, row.names = T) %>%
  kable_styling("striped", full_width = F)

as.data.frame(pw_pfs_8$p.value) %>% 
  rownames_to_column('tmp') %>% 
  mutate_all(~cell_spec(.x, color = ifelse(!is.na(.x) & .x < 0.05, "red", "black"))) %>%
  column_to_rownames('tmp') %>% 
  kable(format = "html", escape = F, row.names = T) %>%
  kable_styling("striped", full_width = F)
```

As we saw in the heatmaps, NCAP and Spike 1 consistently have the highest FS/PFS scores, and VEMP has the lowest. 

```{r, echo=F}
# get_y_pos <- function(g1, g2) {
#   fs_pfs_df %>% 
#     dplyr::filter(parent == "4" & STIM %in% c(g1, g2)) %>% 
#     dplyr::summarise(max(FS)) %>% 
#     as.numeric() + 0.05*max(fs_pfs_df$FS)
# }
# 
# annotation_df <- broom::tidy(pw_fs_4) %>% 
#   mutate(parent = "4",
#          start = match(group1, levels(fs_pfs_df$STIM)),
#          end = match(group2, levels(fs_pfs_df$STIM)),
#          row = 1:nrow(.),
#          y_pos = 1.05*max(fs_pfs_df$FS) + 0.05*row, # unlist(map2(group1, group2, get_y_pos)),
#          p.val.adj.text = if_else(p.value < 0.001, "p<.001", paste0("p=", sub("0.", ".", round(p.value, 3)))))

  # ggsignif::geom_signif(inherit.aes=F,data=annotation_df,
  #                       aes(xmin=start+0.1, xmax=end-0.1,
  #                           annotations=`p.val.adj.text`,
  #                           y_position=y_pos), # , family="Arial"
  #                       tip_length = c(0.005, 0.005),
  #                       textsize=5,
  #                       manual = TRUE) +
#  ylim(c(0, max(1.2*max(fs_pfs_df$FS), 1.2*max(annotation_df$y_pos)))) +
```

# How correlated are FS/PFS across stims?

```{r fig.width=7, fig.height=7}
fs_pfs_df_wide <- fs_pfs_df %>%  
               pivot_wider(id_cols = c(`SAMPLE ID`),
                           names_from = c(STIM, parent),
                           values_from = c(FS, PFS))

pairs.panels(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("^FS.*_4")), 
             method = "pearson", # correlation method, "r" displayed in upper off diagonals. Not r^2.
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots,
             lm = T,
             main = "CD4 FS Correlation across Stims")
```

```{r fig.width=5, fig.height=4}
# Investigate the odd dichotomization of FS_VEMP_4 values:
FS_VEMP_4_dat <- as.data.frame((COMPASS::FunctionalityScore(crList$`4_VEMP`))) %>%
  rownames_to_column("SAMPLE ID") %>%
  rename(`4_VEMP_FS` = "(COMPASS::FunctionalityScore(crList$`4_VEMP`))") %>% 
  left_join(crList$`4_VEMP`$data$meta %>% dplyr::select(`SAMPLE ID`, Batch, Cohort, Age, Sex, Race_v2, `Days symptom onset to visit 1`, `$DATE`),
            by = "SAMPLE ID") %>% 
  left_join(crList$`4_VEMP`$fit$mean_gamma %>% as.data.frame() %>% rownames_to_column("SAMPLE ID"),
            by = "SAMPLE ID") %>% 
  mutate(Batch = factor(ifelse(`$DATE` == "05-JUN-2020", 3, Batch)),
         Cohort = factor(ifelse(Cohort %in%
                                                c(NA, "Healthy control", "Healthy control 2017-2018"), "Healthy", Cohort),
                                              levels = c("Healthy", "Non-hospitalized", "Hospitalized")),
         `Days symptom onset to visit 1` = as.numeric(`Days symptom onset to visit 1`),
         Race_v2 = factor(ifelse(Race_v2 %in%
                                                c(NA, "N/A"), NA, Race_v2),
                                              levels = c("American Indian or Alaska Native", "Asian", "White", NA)))
# It has everything to do with the IL4/5/13 only subset
ggplot(FS_VEMP_4_dat, aes(`!IL2&IL4/5/13&!IFNg&!TNFa&!IL17a&!CD154&!CD107a`, `4_VEMP_FS`)) +
  geom_point() +
  labs(x = "IL4/5/13 only subset mean_gamma")
# But is there another metadata variable which explains the IL4/5/13 dichotomy?
ggplot(FS_VEMP_4_dat, aes(Batch, `4_VEMP_FS`)) +
  theme_bw(base_size = 20) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1)
ggplot(FS_VEMP_4_dat, aes(Cohort, `4_VEMP_FS`)) +
  theme_bw(base_size = 20) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1) +
  theme(axis.text.x = element_text(size=10, angle = 20))
ggplot(FS_VEMP_4_dat, aes(Race_v2, `4_VEMP_FS`)) +
  theme_bw(base_size = 20) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.1) +
  theme(axis.text.x = element_text(size=10, angle = 20))
ggplot(FS_VEMP_4_dat, aes(Age, `4_VEMP_FS`)) +
  theme_bw(base_size = 20) +
  geom_point()
ggplot(FS_VEMP_4_dat, aes(`Days symptom onset to visit 1`, `4_VEMP_FS`)) +
  theme_bw(base_size = 20) +
  geom_point()
FS_VEMP_4_dat %>% dplyr::filter(`4_VEMP_FS` > 0.013) %>% dplyr::select(`SAMPLE ID`, Batch, Cohort, `4_VEMP_FS`) %>% arrange(Batch, Cohort, `SAMPLE ID`)
# These points are in each Batch and are not restricted to a Cohort
```
  
Continue on with the correlatiohn plots   
```{r fig.width=7, fig.height=7}
pairs.panels(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("^FS.*_NOT4")), 
             method = "pearson", # correlation method, "r" displayed in upper off diagonals. Not r^2.
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots,
             lm = T,
             main = "Not-CD4 FS Correlation across Stims")

pairs.panels(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("^FS.*_8")), 
             method = "pearson", # correlation method, "r" displayed in upper off diagonals. Not r^2.
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots,
             lm = T,
             main = "CD8 FS Correlation across Stims")

pairs.panels(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("^PFS.*_4")), 
             method = "pearson", # correlation method, "r" displayed in upper off diagonals. Not r^2.
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots,
             lm = T,
             main = "CD4 FS Correlation across Stims")

pairs.panels(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("^PFS.*_NOT4")), 
             method = "pearson", # correlation method, "r" displayed in upper off diagonals. Not r^2.
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots,
             lm = T,
             main = "Not-CD4 PFS Correlation across Stims")

pairs.panels(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("^PFS.*_8")), 
             method = "pearson", # correlation method, "r" displayed in upper off diagonals. Not r^2.
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots,
             lm = T,
             main = "CD8 FS Correlation across Stims")
```

Matrix of the p-value of the correlation. First for FS and then PFS. Ignoring CD8 run for now.

```{r fig.width=9, fig.height=9}
M <- cor(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(starts_with("FS") & !ends_with("_8")),
         use = "complete.obs") # missing values are handled by casewise deletion
# mat : is a matrix of data
# ... : further arguments to pass to the native R cor.test function
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}
getOption("na.action") # Default behavior of cor.test
# matrix of the p-value of the correlation
p.mat <- cor.mtest(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("FS")))
head(p.mat[, 1:5])

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(M,
         method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=FALSE)
# significant coefficients are colored
```

```{r fig.width=9, fig.height=9}
M <- cor(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("PFS") & !ends_with("_8")),
         use = "complete.obs") # missing values are handled by casewise deletion

# matrix of the p-value of the correlation
p.mat <- cor.mtest(fs_pfs_df_wide %>% 
               dplyr::select(-c(`SAMPLE ID`)) %>% 
               dplyr::select(matches("PFS")))
head(p.mat[, 1:5])

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(M,
         method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # hide correlation coefficient on the principal diagonal
         diag=FALSE)
# significant coefficients are colored
```

Observations:  
(1) Note that FS and PFS scores for the same condition tend to be highly correlated (not shown). Not surprising.  
(2) Within PFS only, there is a mixed bag of significant associations occuring "between CD4 and Not-CD4 for the same condition" and "between different stims". Tends to be much lower r than those for (1) though.  
  
In general, we can't rely on a particular condition to predict the FS/PFS of all the other conditions. Each STIM and co-receptor subset provides different information. (If the former were true, it might have simplified our upcoming analyses)  

# Regress FS/PFS vs Demographics

```{r}
# Read in the patient manifest with complete data (though it's also in the COMPASSResult object)
data_manifest <- read.csv(here::here("data/Seshadri_HAARVI_PBMC_manifest_merged_11June2020.csv"), check.names = F, stringsAsFactors = F)

setdiff(sort(unique(fs_pfs_df$`SAMPLE ID`)), sort(unique(data_manifest$`Record ID`)))
setdiff(sort(unique(data_manifest$`Record ID`)), sort(unique(fs_pfs_df$`SAMPLE ID`)))
```

```{r}
# Remember 116C and 37C didn't get run through COMPASS
# 75C was not run at all
# 07B/551432 didn't get run for Spike 2
# For CD8 only: "BWT20", "15548" didn't get run for "Spike 2", "NCAP", and 15530 didn't get run for "Spike 2"
fs_pfs_df_with_manifest <- fs_pfs_df %>%
  mutate("Record ID" = dplyr::recode(`SAMPLE ID`,
                                     "HS09" = "HS9")) %>% # also, 75C did not get run
  full_join(data_manifest, by = c("Record ID" = "Record ID")) %>% 
  dplyr::filter(!(`Record ID` %in% c("116C", "37C", "75C"))) %>% 
  mutate(Days_Symptom_Onset_to_Visit_1 = as.numeric(`Days symptom onset to visit 1`),
         Cohort = factor(ifelse(Cohort %in%
                                                c(NA, "Healthy control", "Healthy control 2017-2018"), "Healthy", Cohort),
                                              levels = c("Healthy", "Non-hospitalized", "Hospitalized")))
fs_pfs_df_with_manifest %>% dplyr::filter(is.na(FS) | is.na(`Record ID`) | is.na(`SAMPLE ID`) | is.na(STIM) | is.na(Cohort))
```

## FS/PFS vs Age

```{r}
# Note that p-values on ggscatter plots below are *not* adjusted, e.g. compare below results to this unadjusted p-value:
broom::tidy(lm(FS ~ Age, data = fs_pfs_df_with_manifest %>% dplyr::filter(parent == "4" & STIM == "Spike_2")))
```

```{r fig.width=10, fig.height=13}
ggscatter(fs_pfs_df_with_manifest,
          x = "Age", y = "FS",
          color = "STIM", palette = "jco",
          add = "reg.line") +
  facet_grid(parent ~ STIM) +
  stat_cor()

ggscatter(fs_pfs_df_with_manifest,
          x = "Age", y = "PFS",
          color = "STIM", palette = "jco",
          add = "reg.line") +
  facet_grid(parent ~ STIM) +
  stat_cor()
```
  
## FS/PFS vs Days from Symptom Onset to Visit

```{r}
# Note that p-values on ggscatter plots below are *not* adjusted, e.g.:
broom::tidy(lm(FS ~ Days_Symptom_Onset_to_Visit_1, data = fs_pfs_df_with_manifest %>% dplyr::filter(parent == "4" & STIM == "Spike_2")))
```

```{r fig.width=10, fig.height=13}
# Note that the Healthies don't have values for Days_Symptom_Onset_to_Visit_1 and will get filtered out below
ggscatter(fs_pfs_df_with_manifest,
          x = "Days_Symptom_Onset_to_Visit_1", y = "FS",
          color = "STIM", palette = "jco",
          add = "reg.line") +
  facet_grid(parent ~ STIM) +
  stat_cor()

ggscatter(fs_pfs_df_with_manifest,
          x = "Days_Symptom_Onset_to_Visit_1", y = "PFS",
          color = "STIM", palette = "jco",
          add = "reg.line") +
  facet_grid(parent ~ STIM) +
  stat_cor()
```

For the CD4 FS vs Age plots, there is a positive association of Age with FS for Spike 1 (at least).

## FS/PFS vs Sex

```{r}
# Note that p-values on ggboxplot plots below are *not* adjusted, e.g.:
broom::tidy(wilcox.test(FS ~ Sex, data = fs_pfs_df_with_manifest %>% dplyr::filter(parent == "4" & STIM == "Spike_2")))
```

```{r fig.width=10, fig.height=13}
# Note that future ggpubr update should make outlier.shape=NA occur by default when jitter is added, but type out the parameter for now
ggboxplot(fs_pfs_df_with_manifest %>% 
            dplyr::filter(!is.na(Sex)),
          x = "Sex", y = "FS",
          color = "Sex", palette = "jco",
          add = "jitter",
          outlier.shape = NA) + 
  facet_grid(parent ~ STIM) +
  stat_compare_means(aes(group = Sex))

ggboxplot(fs_pfs_df_with_manifest %>% 
            dplyr::filter(!is.na(Sex)),
          x = "Sex", y = "PFS",
          color = "Sex", palette = "jco",
          add = "jitter",
          outlier.shape = NA) + 
  facet_grid(parent ~ STIM) +
  stat_compare_means(aes(group = Sex))
```

In many of the boxplots above, Males are shifted slightly higher on the FS/PFS axis compared to Females, but none of the comparisons are significant. Perhaps a t-test or un-stratified plot would be significant.  
  
# Hosp vs Non-Hosp

(1) Plot the COMPASS heatmaps again, this time including row annotations for Cohort  
(2) Compare FS and PFS between Hosp and Non-Hosp  

## COMPASS Heatmaps

```{r}
# First change any NA Cohort levels to "Healthy"
crList2 <- lapply(crList,
                  function(cr) {
                    cr$data$meta$Cohort <- factor(ifelse(cr$data$meta$Cohort %in%
                                                c(NA, "Healthy control", "Healthy control 2017-2018"), "Healthy", cr$data$meta$Cohort),
                                              levels = rev(c("Healthy", "Non-hospitalized", "Hospitalized")))
                    cr
                  })
names(crList2) <- names(crList)

CohortColors <- c("Healthy" = "#dfc27d", "Non-hospitalized" = "#80cdc1", "Hospitalized" = "#018571")
row_ann_colors <- list(`Cohort` = CohortColors)
cytokine_annotation_colors <- rep("black", 30)
```

```{r, fig.width=12, fig.height=10}
plotCOMPASSResultStack(crList2[CD4RunNames],
                       row_annotation = c("Stim", "Cohort"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13,
                       row_annotation_colors=row_ann_colors,
                       cytokine_annotation_colors=cytokine_annotation_colors,
                       order_by_max_functionality = T)
```

```{r, fig.width=12, fig.height=10}
plotCOMPASSResultStack(crList2[NotCD4RunNames],
                       row_annotation = c("Stim", "Cohort"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "Not-CD4 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13,
                       row_annotation_colors=row_ann_colors,
                       cytokine_annotation_colors=cytokine_annotation_colors,
                       order_by_max_functionality = T)
```

```{r, fig.width=12, fig.height=10}
plotCOMPASSResultStack(crList2[CD8RunNames],
                       row_annotation = c("Stim", "Cohort"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD8 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13,
                       row_annotation_colors=row_ann_colors,
                       cytokine_annotation_colors=cytokine_annotation_colors,
                       order_by_max_functionality = T)
```

```{r, fig.width=12, fig.height=15}
plotCOMPASSResultStack(crList2[c(CD4RunNames, NotCD4RunNames)],
                       row_annotation = c("Stim", "Cohort"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4 and Not-CD4 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13,
                       row_annotation_colors=row_ann_colors,
                       cytokine_annotation_colors=cytokine_annotation_colors,
                       order_by_max_functionality = T)
```

```{r, fig.width=12, fig.height=15}
plotCOMPASSResultStack(crList2[c(CD4RunNames, CD8RunNames)],
                       row_annotation = c("Stim", "Cohort"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4 and CD8 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13,
                       row_annotation_colors=row_ann_colors,
                       cytokine_annotation_colors=cytokine_annotation_colors,
                       order_by_max_functionality = T)
```

```{r, fig.width=12, fig.height=20}
plotCOMPASSResultStack(crList2[c(CD4RunNames, NotCD4RunNames, CD8RunNames)],
                       row_annotation = c("Stim", "Cohort"),
                       variable = "Stim",
                       show_rownames = FALSE,
                       main = "CD4, Not-CD4, and CD8 COMPASS Runs",
                       fontsize = 15, fontsize_row = 15, fontsize_col = 13,
                       row_annotation_colors=row_ann_colors,
                       cytokine_annotation_colors=cytokine_annotation_colors,
                       order_by_max_functionality = T)
```

A commonality to the subsets which are enriched in Hospitalized individuals is CD154.  
  
Now look at each run individually

```{r, fig.width=9, fig.height=12}
cytokine_order_for_annotation = c("IFNg", "IL2", "TNFa", "CD154", "CD107a", "IL4/5/13", "IL17a")

for(cr_name in c(CD4RunNames, NotCD4RunNames, CD8RunNames)) {
  print(my_plot.COMPASSResult(crList2[[cr_name]],
                        y="Cohort",
                        #show_rownames = T,
                        fontsize=16, fontsize_row=16, fontsize_col=19,
                        row_annotation_colors=row_ann_colors,
                        cytokine_annotation_colors=cytokine_annotation_colors,
                        cytokine_height_multiplier=2.5, order_by_max_functionality = T,
                        main=cr_name,
                        cytokine_order_for_annotation=cytokine_order_for_annotation, 
                        staircase_cytokine_annotation=T # Looks prettier and is consistent with dotplots
                        ))
}
```

## FS/PFS vs Cohort

```{r}
# Note that p-values on ggboxplot plots below are *not* adjusted, e.g.:
broom::tidy(wilcox.test(FS ~ Cohort, data = fs_pfs_df_with_manifest %>% dplyr::filter(Cohort != "Healthy" & parent == "4" & STIM == "Spike_2")))
```

```{r fig.width=10, fig.height=13}
# Note that future ggpubr update should make outlier.shape=NA occur by default when jitter is added, but include for now
ggboxplot(fs_pfs_df_with_manifest %>% 
            dplyr::filter(Cohort != "Healthy"),
          x = "Cohort", y = "FS",
          color = "Cohort", palette = "jco",
          add = "jitter",
          outlier.shape = NA) + 
  facet_grid(parent ~ STIM) +
  stat_compare_means(aes(group = Cohort)) +
  scale_x_discrete(labels=c("Non-hospitalized" = "Conv\nNon-Hosp", "Hospitalized" = "Conv\nHosp"))

ggboxplot(fs_pfs_df_with_manifest %>% 
            dplyr::filter(Cohort != "Healthy"),
          x = "Cohort", y = "PFS",
          color = "Cohort", palette = "jco",
          add = "jitter",
          outlier.shape = NA) + 
  facet_grid(parent ~ STIM) +
  stat_compare_means(aes(group = Cohort)) +
  scale_x_discrete(labels=c("Non-hospitalized" = "Conv\nNon-Hosp", "Hospitalized" = "Conv\nHosp"))
```

## Background-corrected magnitudes

```{r, fig.width=12, fig.height=9, warning=F}
crList.no_healthy <- lapply(names(crList2),
                  function(cr_name) {
                    cr <- crList2[[cr_name]]
                    print(sprintf("Accessing %s", cr_name))
                    cr$data$meta <- cr$data$meta %>% 
                      dplyr::filter(!(`SAMPLE ID` %in% setdiff(cr$data$meta$`SAMPLE ID`, rownames(cr$fit$mean_gamma))))
                    stopifnot(all.equal(rownames(cr$fit$mean_gamma), cr$data$meta$`SAMPLE ID`))
                    
                    stopifnot(all.equal(rownames(cr$data$n_s), rownames(cr$fit$mean_gamma)))
                    stopifnot(all.equal(rownames(cr$data$n_u), rownames(cr$fit$mean_gamma)))
                    stopifnot(all.equal(names(cr$data$counts_s), rownames(cr$fit$mean_gamma)))
                    stopifnot(all.equal(names(cr$data$counts_u), rownames(cr$fit$mean_gamma)))
                    
                    not_healthy_idx <- which(cr$data$meta$Cohort != "Healthy")
                    cr$data$meta <- cr$data$meta[not_healthy_idx,] %>% 
                      mutate(Cohort = factor(Cohort, levels = c("Non-hospitalized", "Hospitalized")))
                    cr$fit$mean_gamma <- cr$fit$mean_gamma[not_healthy_idx,]

                    cr$data$n_s <- cr$data$n_s[not_healthy_idx,]
                    cr$data$n_u <- cr$data$n_u[not_healthy_idx,]
                    cr$data$counts_s <- cr$data$counts_s[not_healthy_idx]
                    cr$data$counts_u <- cr$data$counts_u[not_healthy_idx]
                    
                    cr
                  })
names(crList.no_healthy) <- names(crList2)

source(here::here("scripts/20200604_Helper_Functions.R"))

# Arial is used by dotplot function
# Arial font setup. Downloaded afms from https://github.com/microsoft/microsoft-r-open/tree/ec3fd89e5fb5794bd8149905c134ad801bb61800
Arial <- Type1Font(family = "Arial",
                   metrics = c(here::here("data/Arial_afm/ArialMT.afm"),
                               here::here("data/Arial_afm/ArialMT-Bold.afm"), 
                               here::here("data/Arial_afm/ArialMT-Italic.afm"),
                               here::here("data/Arial_afm/ArialMT-BoldItalic.afm")))
pdfFonts(Arial = Arial)

# Note p-values are bonferroni adjusted in dotplots
# Also note that some points are not shown in order to zoom in better to the bulk of the point
bg_corr_dotplots <- pmap(.l = list(c(CD4RunNames, NotCD4RunNames, CD8RunNames),
                                   rep(c("CD4+", "Not-CD4+", "CD8"), each = 4),
                                   list(c(-0.0013, 0.009), c(-0.0018, 0.0085), c(-0.002, 0.0048), NULL,
                                        c(-0.002, 0.0024), c(-0.0012, 0.004), c(-0.002, 0.005), NULL,
                                        c(-0.0025, 0.0065), NULL, c(-0.0015, 0.005), NULL),
                                   c(5, 5, 3, 5,
                                     5, 5, 5, 5,
                                     5, 5, 5, 5)),
                         .f = function(n, p, y, p_text_size) {
                           # "staircase effect" for categories df heatmap gets done automatically, unlike in my_plot.COMPASSResult
                           # Returned dotplot is cowplot
                           make_dotplot_for_COMPASS_run(crList.no_healthy[[n]], n, parentSubset = p,
                                                        return_output = T, current_ylim = y, include_0_line=T, 
                                                        cytokine_order_for_annotation=cytokine_order_for_annotation,
                                                        p_text_size=p_text_size)
                         })
names(bg_corr_dotplots) <- c(CD4RunNames, NotCD4RunNames, CD8RunNames)

for(n in names(bg_corr_dotplots)) {
  print(plot_grid(ggplot() +
    theme_void() +
    geom_text(aes(0,0,label=n), size=10) +
    xlab(NULL),
    bg_corr_dotplots[[n]]$Dotplot,
    ncol=1, rel_heights = c(0.1, 1)))
}
```

```{r}
sig_tests_tally <- lapply(names(bg_corr_dotplots), function(n) {length(which(bg_corr_dotplots[[n]]$Test_Results$p.adj < 0.05))})
names(sig_tests_tally) <- names(bg_corr_dotplots)
sig_tests_tally # make sure all significant comparisons were plotted and accounted for
```

# Focus on IFNg

Look at each run individually again, this time with IFNg subsets on RHS (since vaccine development pays a lot of attention to IFNg)

```{r, fig.width=9, fig.height=12}
for(cr_name in c(CD4RunNames, NotCD4RunNames, CD8RunNames)) {
  print(my_plot.COMPASSResult(crList2[[cr_name]],
                        y="Cohort",
                        #show_rownames = T,
                        fontsize=16, fontsize_row=16, fontsize_col=19,
                        row_annotation_colors=row_ann_colors,
                        cytokine_annotation_colors=cytokine_annotation_colors,
                        cytokine_height_multiplier=2.5, order_by_max_functionality = T,
                        cytokine_order_for_annotation = c("IL4/5/13", "TNFa", "IL17a",
                                                          "CD154", "CD107a", "IL2", "IFNg"),
                        dichotomize_by_cytokine = "IFNg",
                        staircase_cytokine_annotation = TRUE,
                        main=cr_name))
}
```
